<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Editar Funcionário</title>
  <style>
    form {
      max-width: 600px;
      margin: 40px auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #f9f9f9;
    }

    label {
      display: flex;
      flex-direction: column;
    }

    button {
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <h1 style="text-align:center">Editar Funcionário</h1>

  <form id="formEdicaoFuncionario">
    <input type="hidden" name="id" />
    <label>Nome: <input type="text" name="nome" required /></label>
    <label>CPF: <input type="text" name="cpf" required /></label>
    <label>Email: <input type="email" name="email" required /></label>
    <label>Salário: <input type="number" name="salario" step="0.01" /></label>
    <label>Ativo: <input type="checkbox" name="ativo" /></label>

    <fieldset>
      <legend>Endereço</legend>
      <label>País: <input type="text" name="pais" required /></label>
      <label>Estado: <input type="text" name="estado" maxlength="2" required /></label>
      <label>Cidade: <input type="text" name="cidade" required /></label>
      <label>Bairro: <input type="text" name="bairro" required /></label>
      <label>Logradouro: <input type="text" name="logradouro" required /></label>
      <label>Número: <input type="text" name="numero" /></label>
      <label>CEP: <input type="text" name="cep" /></label>
    </fieldset>

    <fieldset>
      <legend>Departamento</legend>
      <select name="idDepartamento" required id="departamentosSelect">
        <option value="">Selecione...</option>
      </select>
    </fieldset>

    <button type="submit">Salvar Alterações</button>
  </form>

  <script>
    const form = document.getElementById("formEdicaoFuncionario");
    const params = new URLSearchParams(window.location.search);
    const funcionarioId = params.get("id");

    async function carregarDepartamentosSelecionaveis(departamentoAtualId) {
      const select = document.getElementById("departamentosSelect");

      try {
        const res = await fetch("http://localhost:8080/departamentos");
        const departamentos = await res.json();

        departamentos.forEach(dep => {
          const option = document.createElement("option");
          option.value = dep.idDepartamento;
          option.textContent = dep.nmDepartamento;
          if (dep.idDepartamento === departamentoAtualId) {
            option.selected = true;
          }
          select.appendChild(option);
        });
      } catch (err) {
        alert("Erro ao carregar departamentos: " + err.message);
      }
    }

    async function carregarFuncionario() {
      try {
        const response = await fetch(`http://localhost:8080/funcionarios/${funcionarioId}`);
        if (!response.ok) throw new Error("Funcionário não encontrado");

        const func = await response.json();
        form.id.value = func.idFuncionario;
        form.nome.value = func.nome;
        form.cpf.value = func.cpf;
        form.email.value = func.email;
        form.salario.value = func.salario;
        form.ativo.checked = func.ativo;

        form.pais.value = func.endereco?.pais || "";
        form.estado.value = func.endereco?.estado || "";
        form.cidade.value = func.endereco?.cidade || "";
        form.bairro.value = func.endereco?.bairro || "";
        form.logradouro.value = func.endereco?.logradouro || "";
        form.numero.value = func.endereco?.numero || "";
        form.cep.value = func.endereco?.cep || "";

        await carregarDepartamentosSelecionaveis(func.idDepartamento?.idDepartamento);

      } catch (error) {
        alert("Erro ao carregar funcionário: " + error.message);
      }
    }

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const funcionario = {
        idFuncionario: parseInt(form.id.value),
        nome: form.nome.value,
        cpf: form.cpf.value,
        email: form.email.value,
        salario: parseFloat(form.salario.value) || 0,
        ativo: form.ativo.checked,
        endereco: {
          pais: form.pais.value,
          estado: form.estado.value,
          cidade: form.cidade.value,
          bairro: form.bairro.value,
          logradouro: form.logradouro.value,
          numero: form.numero.value,
          cep: form.cep.value,
        },
        idDepartamento: {
          idDepartamento: parseInt(form.idDepartamento.value),
        }
      };

      try {
        const res = await fetch("http://localhost:8080/funcionarios", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(funcionario),
        });

        if (res.ok) {
          alert("Funcionário atualizado com sucesso!");
          window.location.href = "listar-funcionarios.html";
        } else {
          const erro = await res.text();
          alert("Erro ao atualizar: " + erro);
        }
      } catch (erro) {
        alert("Erro de rede: " + erro.message);
      }
    });

    carregarFuncionario();
  </script>
</body>
</html>
